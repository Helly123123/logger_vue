<template>
  <div class="auth-container">
    <div class="auth-card">
      <div class="logo">
        <div class="logo-icon">
          <svg
            width="48"
            height="70"
            viewBox="0 0 48 70"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <!-- Твой SVG код остается без изменений -->
            <path
              d="M7.0738 42.2561C5.19771 42.2561 3.39846 43.0418 2.07187 44.4402C0.745274 45.8387 0 47.7354 0 49.7132V51.4531C0 57.9408 2.82952 62.6387 7.32846 65.5867C11.6906 68.4453 17.4959 69.5986 23.5793 69.5986C29.6958 69.5986 35.5011 68.4502 39.8585 65.5867C44.3575 62.6387 47.1587 57.9308 47.1587 51.4531V49.7132C47.1587 47.7354 46.4134 45.8387 45.0868 44.4402C43.7602 43.0418 41.961 42.2561 40.0849 42.2561H7.0738Z"
              fill="url(#paint0_radial_117_3)"
            />
            <path
              d="M7.0738 42.2561C5.19771 42.2561 3.39846 43.0418 2.07187 44.4402C0.745274 45.8387 0 47.7354 0 49.7132V51.4531C0 57.9408 2.82952 62.6387 7.32846 65.5867C11.6906 68.4453 17.4959 69.5986 23.5793 69.5986C29.6958 29.5986 35.5011 68.4502 39.8585 65.5867C44.3575 62.6387 47.1587 57.9308 47.1587 51.4531V49.7132C47.1587 47.7354 46.4134 45.8387 45.0868 44.4402C43.7602 43.0418 41.961 42.2561 40.0849 42.2561H7.0738Z"
              fill="url(#paint1_linear_117_3)"
            />
            <path
              d="M25.9375 2.48568C25.9375 1.82644 25.6891 1.1942 25.2469 0.72804C24.8047 0.261884 24.205 0 23.5796 0C22.9543 0 22.3545 0.261884 21.9123 0.72804C21.4701 1.1942 21.2217 1.82644 21.2217 2.48568V7.45705H25.9375V2.48568Z"
              fill="url(#paint2_linear_117_3)"
            />
            <path
              d="M35.3695 4.9707C37.2455 4.9707 39.0448 5.75635 40.3714 7.15482C41.698 8.55329 42.4433 10.45 42.4433 12.4278V27.3419C42.4433 29.3196 41.698 31.2163 40.3714 32.6148C39.0448 34.0133 37.2455 34.7989 35.3695 34.7989H11.7901C9.91402 34.7989 8.11477 34.0133 6.78818 32.6148C5.46158 31.2163 4.71631 29.3196 4.71631 27.3419V12.4278C4.71631 10.45 5.46158 8.55329 6.78818 7.15482C8.11477 5.75635 9.91402 4.9707 11.7901 4.9707H35.3695Z"
              fill="url(#paint3_radial_117_3)"
            />
            <path
              d="M30.6536 16.1565C29.7156 16.1565 28.8159 16.5493 28.1526 17.2486C27.4893 17.9478 27.1167 18.8962 27.1167 19.885C27.1167 20.8739 27.4893 21.8223 28.1526 22.5215C28.8159 23.2207 29.7156 23.6135 30.6536 23.6135C31.5916 23.6135 32.4913 23.2207 33.1546 22.5215C33.8179 21.8223 34.1905 20.8739 34.1905 19.885C34.1905 18.8962 33.8179 17.9478 33.1546 17.2486C32.4913 16.5493 31.5916 16.1565 30.6536 16.1565Z"
              fill="url(#paint4_linear_117_3)"
            />
            <path
              d="M12.9683 19.885C12.9683 18.8962 13.3409 17.9478 14.0042 17.2486C14.6675 16.5493 15.5671 16.1565 16.5052 16.1565C17.4432 16.1565 18.3428 16.5493 19.0061 17.2486C19.6694 17.9478 20.0421 18.8962 20.0421 19.885C20.0421 20.8739 19.6694 21.8223 19.0061 22.5215C18.3428 23.2207 17.4432 23.6135 16.5052 23.6135C15.5671 23.6135 14.6675 23.2207 14.0042 22.5215C13.3409 21.8223 12.9683 20.8739 12.9683 19.885Z"
              fill="url(#paint5_linear_117_3)"
            />
            <defs>
              <radialGradient
                id="paint0_radial_117_3"
                cx="0"
                cy="0"
                r="1"
                gradientTransform="matrix(56.5678 38.4895 -60.7022 99.1425 -10.8842 33.8396)"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#F08AF4" />
                <stop offset="0.535" stop-color="#9C6CFE" />
                <stop offset="1" stop-color="#4E44DB" />
              </radialGradient>
              <linearGradient
                id="paint1_linear_117_3"
                x1="23.5793"
                y1="38.9999"
                x2="37.5996"
                y2="84.1814"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#885EDB" stop-opacity="0" />
                <stop offset="1" stop-color="#E362F8" />
              </linearGradient>
              <linearGradient
                id="paint2_linear_117_3"
                x1="21.1132"
                y1="-3.12746e-08"
                x2="26.3929"
                y2="5.83433"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#8B52F4" />
                <stop offset="1" stop-color="#3D35B1" />
              </linearGradient>
              <radialGradient
                id="paint3_radial_117_3"
                cx="0"
                cy="0"
                r="1"
                gradientTransform="matrix(44.9414 47.3762 -87.7273 92.4802 -3.67706 -9.0983)"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#F08AF4" />
                <stop offset="0.535" stop-color="#9C6CFE" />
                <stop offset="1" stop-color="#4E44DB" />
              </radialGradient>
              <linearGradient
                id="paint4_linear_117_3"
                x1="28.7955"
                y1="16.4448"
                x2="34.5921"
                y2="25.9332"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#FDFDFD" />
                <stop offset="1" stop-color="#F9DCFA" />
              </linearGradient>
              <linearGradient
                id="paint5_linear_117_3"
                x1="14.6471"
                y1="16.4448"
                x2="20.4436"
                y2="25.9332"
                gradientUnits="userSpaceOnUse"
              >
                <stop stop-color="#FDFDFD" />
                <stop offset="1" stop-color="#F9DCFA" />
              </linearGradient>
            </defs>
          </svg>
        </div>
        <h1>Вход в систему</h1>
      </div>

      <form @submit.prevent="handleLogin" class="auth-form">
        <div class="form-group">
          <input
            v-model="form.login"
            type="text"
            placeholder="Логин"
            :class="{ error: errors.login }"
            @input="clearError('login')"
          />
          <span v-if="errors.login" class="error-message">{{
            errors.login
          }}</span>
        </div>

        <div class="form-group">
          <input
            v-model="form.password"
            type="password"
            placeholder="Пароль"
            :class="{ error: errors.password }"
            @input="clearError('password')"
          />
          <span v-if="errors.password" class="error-message">{{
            errors.password
          }}</span>
        </div>

        <button type="submit" class="login-btn" :disabled="loading">
          <template v-if="!loading"> Войти </template>
          <template v-else>
            <div class="loader"></div>
          </template>
        </button>
      </form>
    </div>

    <!-- Уведомление об ошибке -->
    <div v-if="authError" class="notification error">
      {{ authError }}
    </div>
  </div>
</template>

<script setup>
import { ref, reactive } from "vue";
import { useRouter } from "vue-router";
const VITE_FRONTEND_URL = import.meta.env.VITE_FRONTEND_URL;

const router = useRouter();

// Реактивные данные
const form = reactive({
  login: "",
  password: "",
});

const errors = reactive({
  login: "",
  password: "",
});

const loading = ref(false);
const authError = ref("");

// Валидация формы
const validateForm = () => {
  let isValid = true;

  // Очищаем предыдущие ошибки
  errors.login = "";
  errors.password = "";

  // Проверка логина
  if (!form.login.trim()) {
    errors.login = "Логин обязателен";
    isValid = false;
  }

  // Проверка пароля
  if (!form.password) {
    errors.password = "Пароль обязателен";
    isValid = false;
  }

  return isValid;
};

// Очистка ошибки при вводе
const clearError = (field) => {
  errors[field] = "";
  authError.value = "";
};

// Обработка авторизации
const handleLogin = async () => {
  if (!validateForm()) return;

  loading.value = true;
  authError.value = "";

  try {
    const response = await fetch(`${VITE_FRONTEND_URL}login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        login: form.login,
        password: form.password,
      }),
    });

    const data = await response.json();

    if (data.success) {
      localStorage.setItem("authToken", data.token);
      localStorage.setItem("user", data.user);

      console.log("Успешная авторизация!", data);

      // window.dispatchEvent(new Event("storage"));
      location.reload();
      // Перенаправление на главную страницу
      router.push("/logs");

      // router.push("/logs");
    } else {
      if (data.errorType === "login") {
        errors.login = data.message;
      } else if (data.errorType === "password") {
        errors.password = data.message;
      } else {
        authError.value = data.message || "Ошибка авторизации";
      }
    }
  } catch (error) {
    console.error("Auth error:", error);
    authError.value = "Ошибка подключения к серверу";
  } finally {
    loading.value = false;
  }
};

// Функция для проверки валидности токена (можно использовать позже)
const checkAuth = async () => {
  const token = localStorage.getItem("authToken");

  if (!token) {
    return false;
  }

  try {
    const response = await fetch("http://localhost:3000/api/getLogs", {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    });

    if (response.ok) {
      return true;
    } else {
      // Токен невалидный, удаляем его
      localStorage.removeItem("authToken");
      localStorage.removeItem("user");
      return false;
    }
  } catch (error) {
    console.error("Auth check error:", error);
    return false;
  }
};
</script>

<style scoped>
.auth-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.auth-card {
  background: white;
  padding: 40px 30px;
  border-radius: 12px;
  border: 1px solid #e1e5e9;
  width: 100%;
  max-width: 320px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.logo {
  text-align: center;
  margin-bottom: 30px;
}

.logo-icon {
  width: 70px;
  height: 70px;
  margin: 0 auto 15px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #2c3e50;
  border: 1px solid #e1e5e9;
}

.logo-icon svg {
  width: 40px;
  height: 40px;
}

.logo h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 500;
  color: #2c3e50;
}

.auth-form {
  margin-bottom: 0;
}

.form-group {
  margin-bottom: 20px;
}

input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #dcdfe6;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s ease;
  box-sizing: border-box;
  background: #fafbfc;
}

input:focus {
  outline: none;
  border-color: #3498db;
  background: white;
  box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

input.error {
  border-color: #e74c3c;
}

.error-message {
  color: #e74c3c;
  font-size: 12px;
  margin-top: 5px;
  display: block;
}

.login-btn {
  width: 100%;
  padding: 12px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.login-btn:hover:not(:disabled) {
  background: #34495e;
}

.login-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Лоадер */
.loader {
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid white;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* Уведомление */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  color: white;
  font-size: 14px;
  font-weight: 500;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  animation: slideIn 0.3s ease;
}

.notification.error {
  background: #e74c3c;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Адаптивность */
@media (max-width: 480px) {
  .auth-card {
    padding: 30px 20px;
    border: none;
    box-shadow: none;
  }

  .auth-container {
    background: #f8f9fa;
  }
}
</style>
